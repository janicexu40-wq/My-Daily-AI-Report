name: Daily AI Morning Briefing

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š7ç‚¹è¿è¡Œï¼ˆUTCæ—¶é—´å‰ä¸€å¤©23ç‚¹ï¼‰
    - cron: '0 23 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘æµ‹è¯•
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    # å¿…é¡»ç»™å†™æƒé™ï¼Œå¦åˆ™æ— æ³• push å›ä»“åº“
    permissions:
      contents: write

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸš€ å¯åŠ¨æ™¨é—´çŒæ‰‹ (ç”Ÿæˆ -> ä¸Šä¼  -> æ¸…ç†)
      env:
        # ä¼ é€’æ‰€æœ‰å¿…è¦çš„å¯†é’¥
        DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
        ALIYUN_REFRESH_TOKEN: ${{ secrets.ALIYUN_REFRESH_TOKEN }}
        BARK_KEY: ${{ secrets.BARK_KEY }}
      run: |
        # è¿è¡Œæ ¸å¿ƒ Python è„šæœ¬
        python main.py

    - name: ğŸ“¤ åŒæ­¥å˜æ›´åˆ°ä»“åº“
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # å…³é”®æ­¥éª¤ï¼šæ·»åŠ æ‰€æœ‰å˜æ›´ï¼ˆåŒ…æ‹¬ python è„šæœ¬åˆ é™¤çš„æ–‡ä»¶ï¼‰
        git add .
        
        # æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨æäº¤ä¿¡æ¯ä¸­åŠ å…¥ (+8 hours) çš„åŒ—äº¬æ—¶é—´
        git diff --quiet && git diff --staged --quiet || git commit -m "ğŸš€ è‡ªåŠ¨æ›´æ–°ï¼šç”Ÿæˆæ–°æƒ…æŠ¥å¹¶æ¸…ç†æ—§æ–‡ä»¶ $(date -d '+8 hours' +'%Y-%m-%d %H:%M')"
        
        git push
