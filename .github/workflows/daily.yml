name: Daily AI Morning Briefing

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š7ç‚¹è¿è¡Œï¼ˆUTCæ—¶é—´å‰ä¸€å¤©23ç‚¹ï¼‰
    - cron: '0 23 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘æµ‹è¯•
  workflow_dispatch:

jobs:
  generate-and-upload:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥æäº¤ç”Ÿæˆçš„æ–‡ä»¶
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ è®¾ç½® Python çŽ¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install --break-system-packages feedparser requests edge-tts aligo markdown
        # æ³¨æ„ï¼šè¿™é‡Œè¡¥å……äº† markdown åº“ï¼Œé˜²æ­¢ main.py æŠ¥é”™
        
    - name: ðŸ¤– ç”Ÿæˆæ™¨é—´æƒ…æŠ¥
      env:
        DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
        BARK_KEY: ${{ secrets.BARK_KEY }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        echo "å¼€å§‹ç”Ÿæˆæ™¨é—´æƒ…æŠ¥..."
        python main.py
        echo "æƒ…æŠ¥ç”Ÿæˆå®Œæˆ"
        
    - name: â˜ï¸ ä¸Šä¼ åˆ°é˜¿é‡Œäº‘ç›˜
      env:
        ALIYUN_REFRESH_TOKEN: ${{ secrets.ALIYUN_REFRESH_TOKEN }}
        # æ³¨æ„ï¼šä¸è¦åœ¨è¿™é‡Œç›´æŽ¥å†™å¸¦æ˜Ÿå·çš„æ–‡ä»¶å
      run: |
        echo "å‡†å¤‡ä¸Šä¼ åˆ°é˜¿é‡Œäº‘ç›˜..."
        # === æ ¸å¿ƒä¿®å¤ï¼šåŠ¨æ€æŸ¥æ‰¾ç”Ÿæˆçš„mp3æ–‡ä»¶ ===
        export AUDIO_FILE=$(ls output/briefing_*.mp3 | head -n 1)
        
        if [ -z "$AUDIO_FILE" ]; then
          echo "âŒ æœªæ‰¾åˆ°éŸ³é¢‘æ–‡ä»¶ï¼Œè·³è¿‡ä¸Šä¼ "
          exit 1
        fi
        
        echo "âœ… æ‰¾åˆ°ç›®æ ‡æ–‡ä»¶: $AUDIO_FILE"
        python upload_to_aliyunpan.py
        
    - name: ðŸ§¹ æ¸…ç†æ—§æ–‡ä»¶ï¼ˆåªä¿ç•™æœ€è¿‘3å¤©ï¼‰
      run: |
        echo "å¼€å§‹æ¸…ç†æ—§æ–‡ä»¶..."
        find output/ -name "*.mp3" -type f -mtime +3 -delete 2>/dev/null || true
        find output/ -name "*.txt" -type f -mtime +3 -delete 2>/dev/null || true
        find output/ -name "*.html" -type f -mtime +3 -delete 2>/dev/null || true
        find output/ -name "*.md" -type f -mtime +3 -delete 2>/dev/null || true
        
    - name: ðŸ“¤ æäº¤ç”Ÿæˆçš„æ–‡ä»¶åˆ° GitHub
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        # ç¡®ä¿æäº¤æ‰€æœ‰ç”Ÿæˆæ ¼å¼çš„æ–‡ä»¶
        git add output/ feed.xml
        # å¦‚æžœæœ‰å˜æ›´æ‰æäº¤
        git diff --quiet && git diff --staged --quiet || git commit -m "ðŸ”„ æ›´æ–°æ™¨é—´æƒ…æŠ¥ $(date +'%Y-%m-%d %H:%M')"
        git push
      
    - name: ðŸ“Š ç”Ÿæˆè¿è¡Œç»Ÿè®¡æŠ¥å‘Š
      if: always()
      run: |
        echo "### ðŸ“ˆ è¿è¡Œç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
        TODAY=$(date +%Y%m%d)
        AUDIO_FILE=$(ls output/briefing_${TODAY}.mp3 2>/dev/null || echo "")
        
        if [ -f "$AUDIO_FILE" ]; then
           FILE_SIZE=$(du -h "$AUDIO_FILE" | cut -f1)
           echo "- ðŸŽ™ï¸ éŸ³é¢‘ç”ŸæˆæˆåŠŸ: $FILE_SIZE" >> $GITHUB_STEP_SUMMARY
        else
           echo "- âš ï¸ éŸ³é¢‘æ–‡ä»¶æœªæ‰¾åˆ°" >> $GITHUB_STEP_SUMMARY
        fi
        echo "- â° å®Œæˆæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
