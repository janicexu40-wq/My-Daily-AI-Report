name: Daily AI Morning Briefing

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š7ç‚¹è¿è¡Œï¼ˆUTCæ—¶é—´23ç‚¹å‰ä¸€å¤©ï¼‰
    - cron: '0 23 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºŽæµ‹è¯•ï¼‰
  workflow_dispatch:

jobs:
  generate-briefing:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥æäº¤ç”Ÿæˆçš„æ–‡ä»¶
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ è®¾ç½® Python çŽ¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install feedparser requests edge-tts
        
    - name: ðŸ¤– è¿è¡Œ AI æƒ…æŠ¥ç”Ÿæˆå™¨
      env:
        DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
        BARK_KEY: ${{ secrets.BARK_KEY }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        python main.py
        
    - name: ðŸ“¤ æäº¤ç”Ÿæˆçš„æ–‡ä»¶
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add output/ feed.xml
        git diff --quiet && git diff --staged --quiet || git commit -m "ðŸ”„ æ›´æ–°æ™¨é—´æƒ…æŠ¥ $(date +'%Y-%m-%d %H:%M')"
        git push
      
    - name: ðŸ“Š è¾“å‡ºè¿è¡Œç»Ÿè®¡
      if: always()
      run: |
        echo "### ðŸ“ˆ è¿è¡Œç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f output/briefing.txt ]; then
          WORD_COUNT=$(wc -m < output/briefing.txt)
          echo "- ðŸ“ æ–‡ç¨¿å­—æ•°: $WORD_COUNT å­—" >> $GITHUB_STEP_SUMMARY
        fi
        if [ -f output/briefing.mp3 ]; then
          FILE_SIZE=$(du -h output/briefing.mp3 | cut -f1)
          echo "- ðŸŽ™ï¸ éŸ³é¢‘å¤§å°: $FILE_SIZE" >> $GITHUB_STEP_SUMMARY
        fi
        echo "- â° å®Œæˆæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
